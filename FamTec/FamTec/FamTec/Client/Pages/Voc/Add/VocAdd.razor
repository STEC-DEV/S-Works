@layout MainLayout2
@page "/m/voc/add/{PlaceId:int}/{BuildingId:int}"
@using FamTec.Client.Pages.CommonComponents
@using FamTec.Client.Pages.Voc.Add.Components
@using FamTec.Shared.Client.Class
@using FamTec.Shared.Client.DTO.Normal.Voc
@using FamTec.Shared.Server.DTO


<div class="voc ">
    <div class="header yappear">
        <span class="title">
            @PlaceName [@BuildingName] 민원 접수
        </span>
    </div>
    <div class="content yappear">
        <InputCol Label="성함"
                  @bind-Value=@Voc.Name
                  Placeholder="성함" />
        <InputCol Label="휴대폰 번호"
                  @bind-Value=@Voc.PhoneNumber
                  Placeholder="휴대폰 번호" />
        <InputCol Label="제목"
                  @bind-Value=@Voc.Title
                  Placeholder="제목" />
        <VocInput Label="내용"
                  @bind-Value=@Voc.Contents
                  Placeholder="내용"
                  TextArea=true
                  Height=true />
        <InputImages MaxFilesNum="3" OnChange="OnUploadImage" />
        
    </div>
    <div class="checkitem">
        <CheckItem CheckPerm="OnCheckPerm" />
    </div>

    <div class="btns yappear">
        @if(permCheck){
            <Button Name="접수" Type="0" OnClick="@OnAdd" />
        }
        else
        {
            <button class="blockbtn">접수</button>
        }
        
    </div>
</div>

@code {
    [Parameter] public int PlaceId { get; set; }
    [Parameter] public int BuildingId { get; set; }
    AddVoc Voc = new AddVoc();
    AddVocReturnDTO ResponseData = new AddVocReturnDTO();
    int maxAllowedFiles = 3;

    string PlaceName = "";
    string BuildingName = "";

    //개인약관 체크
    private bool permCheck = false;


    protected override async Task OnInitializedAsync()
    {
        await OnLoadBuildingName();
        await OnLoadPlaceName();
    }

    private async Task OnLoadBuildingName()
    {
        try
        {
            ResponseUnit<string> resGet = await apiManager.GetUnitAsync<string>($"Building/GetBuildingName?buildingid={BuildingId}");
            if(resGet.code != 200)
            {
                await JS.InvokeVoidAsync("alert", resGet.message);
                return;
            }
            BuildingName = resGet.data;
        }catch(Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "[민원] 건물조회 에러");
        }
    }

    private async Task OnLoadPlaceName()
    {
        try
        {
            ResponseUnit<string> resGet = await apiManager.GetUnitAsync<string>($"Place/GetPlaceName?placeid={PlaceId}");
            if(resGet.code != 200)
            {
                await JS.InvokeVoidAsync("alert", resGet.message);
                return;
            }
            PlaceName = resGet.data;
        }catch(Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "[민원] 건물조회 에러");
        }
    }

    private async Task OnAdd()
    {
        try
        {
            if (String.IsNullOrEmpty(Voc.Name) || String.IsNullOrEmpty(Voc.PhoneNumber) || String.IsNullOrEmpty(Voc.Title) || String.IsNullOrEmpty(Voc.Contents))
            {
                await JS.InvokeVoidAsync("alert", "공백이 존재합니다.");
                return;
            }
            if (!permCheck)
            {
                await JS.InvokeVoidAsync("alert", "개인정보 수집 및 이용 동의 약관을 확인해주세요.");
                return;
            }
            Voc.Placeid = PlaceId;
            Voc.Buildingid = BuildingId;
            ResponseUnit<AddVocReturnDTO> resAdd = await apiManager.PostWithFilesAsync<AddVocReturnDTO>("Hub/AddVoc", Voc);
            if(resAdd.code != 200)
            {
                await JS.InvokeVoidAsync("alert", "민원 추가 실패");
            }
            ResponseData = resAdd.data;
            Navigation.NavigateTo($"/voc/add/result?code={resAdd.code}&Cd={ResponseData.ReceiptCode}&Num={ResponseData.PhoneNumber}&Dt={ResponseData.CreateDT}");
        }catch(Exception ex)
        {
            Console.WriteLine(ex);
            await JS.InvokeVoidAsync("alert", "민원 추가 에러");
        }
    }

    private async void OnUploadImage(List<ImageFile> images)
    {
        List<byte[]> temp = new List<byte[]>();
        List<string> names = new List<string>();
        foreach(var image in images)
        {
            temp.Add(image.Image);
            names.Add(image.Name);

        }
        Voc.Image = temp;
        Voc.ImageName = names;
    }

    private void Return()
    {
        Navigation.NavigateTo("/voc/banner");
    }

    private async void OnCheckPerm(bool isChecked)
    {
        permCheck = isChecked;
    }
}
