@layout MainLayout2

@page "/userexcel"
@using ClosedXML.Excel
@using System.Text
@using System.Text.Json
@using System.Drawing

@using System.IO.Compression
@using Tewr.Blazor.FileReader
@using Microsoft.Net.Http.Headers
@using static System.Net.Mime.MediaTypeNames
@inject IFileReaderService fileReader
@inject HttpClient httpClient

@inject IJSRuntime JS

<h3>사용자 엑셀 예시</h3>

<input type="button" value="사용자 등록 엑셀양식 다운로드" @onclick="(() =>  btnClick())"/>

<div id="text">
    <span>
    asdfasdf
    asdfasdf
    asdf
    asdf
    asd
    fasd
    fasd
    </span>
</div>

<input type="button" value="압축테스트" @onclick="(() => btnClick3())"/>

@if (!string.IsNullOrEmpty(imageUrl))
{
    <img src="@imageUrl" alt="Fetched Image" style="width:100px;height:100px"/>
}

<InputFile OnChange="OnInputFileChange" />
<input type="button" value="업로드 테스트" @onclick="(() => btnUpload())"/>



@code {
    private string? excelData;
    string fileName{ get; set; }
    string fileContent{ get; set; }

    string imageUrl { get; set; }

    private IBrowserFile selectedFile;

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }

    private async Task btnUpload()
    {
        if (selectedFile == null)
        {
            Console.WriteLine("파일을 선택하세요.");
            return;
        }

        using var memoryStream = new MemoryStream();
        // selectedFile의 스트림을 MemoryStream에 복사
        await selectedFile.OpenReadStream().CopyToAsync(memoryStream);
        memoryStream.Position = 0; // MemoryStream의 위치를 처음으로 설정

        using var content = new MultipartFormDataContent();
        // MemoryStream을 StreamContent로 감싸고 파일 정보 추가
        var fileContent = new StreamContent(memoryStream);






        fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(selectedFile.ContentType);
        content.Add(fileContent, "file", selectedFile.Name);
        

    }



    protected async Task btnClick3()
    {
        try
        {
            var imageBytes = await HttpClient.GetByteArrayAsync("http://123.2.156.148:5245/api/Voc/temp");
             if (imageBytes == null || imageBytes.Length == 0)
             {
                 Console.WriteLine("Failed to fetch the image or received empty data.");
                 return;
             }

             // Base64로 인코딩하여 이미지 URL 생성
             imageUrl = $"data:image/png;base64,{Convert.ToBase64String(imageBytes)}";
             StateHasChanged();
             Console.WriteLine("Image URL generated successfully.");
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"Request error: {ex.Message}");
        }
    }

    protected async Task btnClick()
    {
        // 엑셀 파일 만듬
        var workbook = new XLWorkbook();

        var worksheet = workbook.Worksheets.Add("사용자등록");

        List<string> Title = new List<string>()
        {
            "아이디",
            "비밀번호",
            "이름",
            "이메일",
            "전화번호"
        };

        worksheet = CreateCell(worksheet, Title.Count(), Title);

        MemoryStream XLSStream = new();
        workbook.SaveAs(XLSStream, false);
        byte[] byteData = XLSStream.ToArray();

        await JS.InvokeAsync<object>("saveAsFile", "사용자정보.xlsx", System.Convert.ToBase64String(byteData)); // 파일명은 토큰에서 따서 사업장명 쓰면됨.
    }

    private IXLWorksheet CreateCell(IXLWorksheet sheet, int colNum, List<string>title)
    {
        for (int i = 0; i < colNum; i++)
        {
            sheet.Cell(1, i + 1).Value = title[i].ToString();
            sheet.Column(i + 1).Width = 15; // 너비
            sheet.Row(1).Height = 15; // 높이

            var cell = sheet.Cell(1, i + 1); // A1,A2,A3 .. 셀 선택
            cell.Style.Font.FontName = "맑은 고딕"; // 셀의 문자의 글꼴을 설정
            cell.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center; // Horizontal 중앙정렬
            cell.Style.Alignment.Vertical = XLAlignmentVerticalValues.Center; // Vertial 중앙정렬
            cell.Style.Border.OutsideBorder = XLBorderStyleValues.Double;
            cell.Style.Border.OutsideBorderColor = XLColor.White;
        }

        var range = sheet.Range(sheet.Cell("A1"), sheet.Cell("E1"));
        
        // 범위 내의 모든 셀의 배경색을 에스텍색으로 설정
        Color color = Color.FromArgb(2241348);
        range.Style.Fill.BackgroundColor = XLColor.FromColor(color);
        range.Style.Font.Bold = true;
        range.Style.Font.FontColor = XLColor.White;

        var mergerange = sheet.Range(sheet.Cell("H1"), sheet.Cell("N7"));
        mergerange.Merge(); // Merge ()에서 범위의 셀을 결합하는

        mergerange.Value = $"*[해당내용은 참고사항입니다]\r\n업로드 후 생성된 아이디로 로그인하셔서 정보수정 바랍니다.";
        mergerange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Left;
        mergerange.Style.Alignment.Vertical = XLAlignmentVerticalValues.Top;

        return sheet;
    }
}
